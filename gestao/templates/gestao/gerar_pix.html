{% extends 'gestao/base.html' %}
{% load l10n %}

{% block title %}Pagamento PIX - Pedido #{{ pedido.numero_pedido }}{% endblock %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="card shadow-lg border-0" style="max-width: 500px; width: 100%; border-radius: 15px;">
        <div class="card-header bg-success text-white text-center py-4" style="border-radius: 15px 15px 0 0;">
            <i class="fas fa-qrcode fa-3x mb-2"></i>
            <h4 class="mb-0 fw-bold">Pagamento via PIX</h4>
            <p class="mb-0 opacity-75">Pedido Nº {{ pedido.numero_pedido }}</p>
        </div>

        <div class="card-body p-4 text-center">
            
            <div class="mb-4">
                <p class="text-muted text-uppercase small mb-1">Valor a Pagar</p>
                <h1 class="display-4 fw-bold text-success">R$ {{ pedido.valor_total|localize }}</h1>
            </div>

            <div class="p-3 bg-light rounded border d-inline-block mb-4">
                {% if qrcode_base64 %}
                    <img src="data:image/png;base64,{{ qrcode_base64 }}" alt="QR Code PIX" style="width: 250px; height: 250px;">
                {% else %}
                    <p class="text-danger">Erro ao gerar QR Code.</p>
                {% endif %}
            </div>

            <div class="mb-3 text-start">
                <label class="form-label small text-muted fw-bold">Pix Copia e Cola:</label>
                <div class="input-group">
                    <input type="text" class="form-control bg-light" id="pix-code" value="{{ pix_copia_e_cola }}" readonly>
                    <button class="btn btn-outline-primary" type="button" onclick="copiarPix()">
                        <i class="fas fa-copy"></i> Copiar
                    </button>
                </div>
                <div id="copy-feedback" class="form-text text-success fw-bold mt-2" style="opacity: 0; transition: opacity 0.3s;">
                    <i class="fas fa-check"></i> Código copiado com sucesso!
                </div>
            </div>

            <div class="alert alert-light border mt-4 text-start small">
                <ol class="mb-0 ps-3">
                    <li>Abra o app do seu banco.</li>
                    <li>Escolha a opção <strong>PIX</strong> > <strong>Pagar com QR Code</strong> ou <strong>Copia e Cola</strong>.</li>
                    <li>Confirme os dados e o valor.</li>
                </ol>
            </div>
        </div>

        <div class="card-footer bg-white text-center py-3 border-0">
            <button onclick="window.close()" class="btn btn-link text-muted text-decoration-none">Fechar Janela</button>
        </div>
    </div>
</div>

<script>
    function copiarPix() {
        var copyText = document.getElementById("pix-code");
        
        // Seleciona o texto (para mobile e PC)
        copyText.select();
        copyText.setSelectionRange(0, 99999); // Para mobile

        // Copia para a área de transferência
        navigator.clipboard.writeText(copyText.value).then(function() {
            // Mostra mensagem de sucesso
            var feedback = document.getElementById("copy-feedback");
            feedback.style.opacity = "1";
            
            // Esconde mensagem depois de 3 segundos
            setTimeout(function(){ 
                feedback.style.opacity = "0"; 
            }, 3000);
        }, function(err) {
            alert('Não foi possível copiar automaticamente. Por favor, selecione e copie manualmente.');
        });
    }
</script>
{% endblock %}
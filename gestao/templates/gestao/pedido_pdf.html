<!DOCTYPE html>
<html lang="pt-br">
{% load l10n gestao_filters static %}
<head>
    <meta charset="UTF-8">
    <title>Pedido {{ pedido.numero_pedido }}</title>
    <style>
        /* 1. OTIMIZAÇÃO DE ESPAÇO */
        @page { size: A4; margin: 0.8cm; }
        
        body { font-family: 'Helvetica', 'Arial', sans-serif; font-size: 9pt; color: #000; line-height: 1.3; }
        
        /* Helpers */
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-bold { font-weight: bold; }
        .w-100 { width: 100%; }
        
        /* Tabelas Gerais */
        table { width: 100%; border-collapse: collapse; }
        td { vertical-align: top; padding: 2px; }

        /* HEADER */
        .header-box { border-bottom: 2px solid #444; padding-bottom: 5px; margin-bottom: 10px; }
        .logo-img { max-height: 50px; max-width: 180px; }
        .company-info { font-size: 8pt; color: #444; }
        .icon { width: 10px; height: 10px; vertical-align: middle; margin-right: 2px; }

        /* CONTAINER CLIENTE E PEDIDO */
        .client-box { border: 1px solid #ccc; font-size: 9pt; }
        
        /* 2. ALTERAÇÃO DO CLIENTE:
           Mais espaçamento (padding: 15px) e alinhamento vertical no meio (middle) 
        */
        .client-data { 
            padding: 15px 10px; /* Espaço em cima/embaixo */
            vertical-align: middle; /* Centraliza verticalmente */
        }

        /* 3. ESTILO DOS CARDS DO PEDIDO 
           Borda fina, fundo suave, cantos arredondados (se o gerador de PDF suportar)
        */
        .order-data { 
            width: 28%; 
            border-left: 1px solid #ccc; 
            padding: 5px; 
            vertical-align: middle;
        }
        
        .card-box {
            border: 1px solid #ddd;
            background-color: #fafafa; /* Fundo muito leve */
            border-radius: 4px;
            padding: 4px;
            text-align: center;
            margin-bottom: 4px;
        }
        
        .card-label {
            font-size: 6pt;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1px;
        }
        
        .card-value {
            font-size: 9pt;
            font-weight: bold;
            color: #000;
        }
        
        /* Card do Pedido é maior */
        .card-value.big {
            font-size: 14pt;
            color: #333;
        }

        /* AREA DO PIX */
        .pix-container { 
            width: 18%; 
            text-align: center; 
            padding: 5px; 
            border-left: 1px solid #ccc; 
            vertical-align: middle; 
        }
        .pix-img { max-width: 80px; height: auto; }
        
        /* CARIMBO PAGO */
        .paid-stamp { 
            color: #198754; 
            border: 2px dashed #198754; 
            border-radius: 10px;
            padding: 5px 10px; 
            font-size: 12pt; 
            font-weight: bold; 
            display: inline-block;
            transform: rotate(-10deg); 
            opacity: 0.9; 
        }

        /* TABELA DE ITENS */
        .items-table { margin-top: 10px; font-size: 9pt; }
        .items-table th { 
            background-color: #f0f0f0; 
            color: #000; 
            padding: 4px; 
            font-size: 8pt; 
            text-align: left; 
            border-bottom: 1px solid #999;
        }
        .items-table td { border-bottom: 1px solid #eee; padding: 4px; }
        
        /* TOTAIS E OBS */
        .totals-row td { padding: 2px; text-align: right; }
        .grand-total { font-size: 11pt; font-weight: bold; border-top: 1px solid #000; padding-top: 5px; }
        .box-title { background-color: #f0f0f0; font-size: 8pt; font-weight: bold; padding: 3px 5px; border-bottom: 1px solid #ccc; }
        .obs-box { margin-top: 10px; font-size: 8pt; color: #555; border: 1px dashed #ccc; padding: 5px; min-height: 30px; }
        
        /* LINHA DE CORTE */
        .cut-line { margin-top: 25px; border-top: 1px solid #000; width: 100%; }
    </style>
</head>
<body>

    <div class="header-box">
        <table>
            <tr>
                <td style="width: 50%;">
                    {% if logo_base64 %}
                        <img src="data:image/png;base64,{{ logo_base64 }}" class="logo-img">
                    {% elif empresa.logo %}
                        <img src="{{ empresa.logo.url }}" class="logo-img">
                    {% else %}
                        <h2 style="margin:0;">{{ empresa.nome_fantasia }}</h2>
                    {% endif %}
                </td>
                <td class="text-right company-info">
                    <span class="text-bold">{{ empresa.nome_fantasia }}</span><br>
                    {% if whatsapp_b64 %}
                        <img src="data:image/svg+xml;base64,{{ whatsapp_b64 }}" class="icon">
                    {% else %}
                        <img src="{% static 'gestao/img/whatsapp.svg' %}" class="icon">
                    {% endif %}
                    {{ empresa.celular|default:empresa.telefone_fixo|formatar_telefone }}
                    <br>
                    {% if instagram_b64 %}
                        <img src="data:image/svg+xml;base64,{{ instagram_b64 }}" class="icon">
                    {% else %}
                        <img src="{% static 'gestao/img/instagram.svg' %}" class="icon">
                    {% endif %}
                    {{ empresa.rede_social }}
                </td>
            </tr>
        </table>
    </div>

    <table class="client-box">
        <tr>
            <td style="width: 54%;" class="client-data">
                <div style="margin-bottom: 5px;">
                    <span class="text-bold" style="font-size: 11pt;">{{ pedido.cliente.nome_razao_social }}</span>
                    {% if pedido.cliente.apelido %} <span style="color: #666;">({{ pedido.cliente.apelido }})</span>{% endif %}
                </div>
                <div>
                    {# --- BLOCO 1: Rua, Número e Complemento --- #}
                    {% if pedido.cliente.logradouro %}
                        {{ pedido.cliente.logradouro }}
                        {% if pedido.cliente.numero %}, {{ pedido.cliente.numero }}{% endif %}
                        {% if pedido.cliente.complemento %} - {{ pedido.cliente.complemento }}{% endif %}
                        <br>
                    {% endif %}

                    {# --- BLOCO 2: Bairro, Cidade e UF --- #}
                    {% if pedido.cliente.bairro or pedido.cliente.cidade %}
                        {% if pedido.cliente.bairro %}
                            {{ pedido.cliente.bairro }}
                            {% if pedido.cliente.cidade %} - {% endif %}
                        {% endif %}
                        
                        {% if pedido.cliente.cidade %}
                            {{ pedido.cliente.cidade }}{% if pedido.cliente.uf %}/{{ pedido.cliente.uf }}{% endif %}
                        {% endif %}
                        <br> {% endif %}
                    
                    {# --- BLOCO 3: Telefone --- #}
                    {% with telefone=pedido.cliente.celular|default:pedido.cliente.telefone_fixo %}
                        {% if telefone %}
                            <strong>Tel:</strong> {{ telefone|formatar_telefone }}
                        {% endif %}
                    {% endwith %}
                </div>
            </td>

            <td class="order-data">
                <div class="card-box" style="margin-bottom: 6px;">
                    <div class="card-label">NÚMERO DO PEDIDO</div>
                    <div class="card-value big">{{ pedido.numero_pedido }}</div>
                </div>

                <table style="width: 100%;">
                    <tr>
                        <td style="width: 50%; padding-right: 2px;">
                            <div class="card-box">
                                <div class="card-label">EMISSÃO</div>
                                <div class="card-value">{{ pedido.data_emissao|date:"d/m/y" }}</div>
                            </div>
                        </td>
                        <td style="width: 50%; padding-left: 2px;">
                            <div class="card-box">
                                <div class="card-label">ENTREGA</div>
                                <div class="card-value">{{ pedido.data_entrega|date:"d/m/y"|default:"-" }}</div>
                            </div>
                        </td>
                    </tr>
                </table>
            </td>

            <td class="pix-container">
                {% if pedido.pago %}
                    <div class="paid-stamp">PAGO</div>
                {% elif qrcode_base64 %}
                    <div style="font-size: 6pt; font-weight: bold; margin-bottom: 2px;">PAGUE VIA PIX</div>
                    <img src="data:image/png;base64,{{ qrcode_base64 }}" class="pix-img">
                {% endif %}
            </td>
        </tr>
    </table>

    <table class="items-table">
        <thead>
            <tr>
                <th style="width: 55%;">DESCRIÇÃO</th>
                <th style="width: 10%; text-align: center;">QTD</th>
                <th style="width: 15%; text-align: right;">UNIT (R$)</th>
                <th style="width: 20%; text-align: right;">TOTAL (R$)</th>
            </tr>
        </thead>
        <tbody>
            {% for item in itens_pedido %}
            <tr>
                <td>{{ item.item.nome }}</td>
                <td class="text-center">{{ item.quantidade|floatformat:"-3g" }}</td>
                <td class="text-right">{{ item.preco_unitario|localize }}</td>
                <td class="text-right text-bold">{{ item.subtotal|localize }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <table>
        <tr>
            <td style="width: 55%; padding-top: 10px;">
                {% if pedido.observacoes %}
                    <div class="box-title" style="border: 1px solid #ccc; border-bottom: none;">OBSERVAÇÕES</div>
                    <div class="obs-box" style="border-top: none; border: 1px solid #ccc; margin-top: 0;">
                        {{ pedido.observacoes|linebreaksbr }}
                    </div>
                {% endif %}
            </td>

            <td style="width: 45%; padding-left: 10px;">
                <table class="totals-row" style="margin-top: 10px;">
                    <tr>
                        <td>Subtotal:</td>
                        <td>{{ pedido.subtotal_itens|localize }}</td>
                    </tr>
                    {% if pedido.desconto_calculado > 0 %}
                    <tr>
                        <td style="color: #d9534f;">Desconto:</td>
                        <td style="color: #d9534f;">- {{ pedido.desconto_calculado|localize }}</td>
                    </tr>
                    {% endif %}
                    {% if pedido.taxa_entrega > 0 %}
                    <tr>
                        <td>Entrega:</td>
                        <td>+ {{ pedido.taxa_entrega|localize }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td class="grand-total">TOTAL A PAGAR:</td>
                        <td class="grand-total">R$ {{ pedido.valor_total|localize }}</td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    
    <div class="cut-line"></div>

</body>
</html>